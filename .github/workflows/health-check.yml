name: Health Check

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  health-check:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Discover deployed services
        id: discover
        run: |
          # Find all services with health-check.sh
          SERVICES=$(find services -name "health-check.sh" -type f | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Found services with health checks: $SERVICES"

      - name: Run health checks
        run: |
          SERVICES='${{ steps.discover.outputs.services }}'
          FAILED_SERVICES=()
          PASSED_SERVICES=()
          
          echo "üè• Running health checks..."
          echo ""
          
          for SERVICE in $(echo $SERVICES | jq -r '.[]'); do
            echo "Checking: $SERVICE"
            
            if [ -f "services/$SERVICE/health-check.sh" ]; then
              chmod +x "services/$SERVICE/health-check.sh"
              
              if timeout 60 "services/$SERVICE/health-check.sh" 2>&1; then
                echo "‚úÖ $SERVICE: HEALTHY"
                PASSED_SERVICES+=("$SERVICE")
              else
                echo "‚ùå $SERVICE: FAILED"
                FAILED_SERVICES+=("$SERVICE")
              fi
            else
              echo "‚ö†Ô∏è  $SERVICE: No health check script"
            fi
            
            echo ""
          done
          
          # Export results for next step
          echo "FAILED_COUNT=${#FAILED_SERVICES[@]}" >> $GITHUB_ENV
          echo "PASSED_COUNT=${#PASSED_SERVICES[@]}" >> $GITHUB_ENV
          echo "FAILED_SERVICES=${FAILED_SERVICES[*]}" >> $GITHUB_ENV
          echo "PASSED_SERVICES=${PASSED_SERVICES[*]}" >> $GITHUB_ENV

      - name: Generate health report
        if: always()
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## Health Check Report
          
          **Date:** $(date)
          
          ### Summary
          - ‚úÖ Passed: ${{ env.PASSED_COUNT }}
          - ‚ùå Failed: ${{ env.FAILED_COUNT }}
          
          EOF
          
          if [ "${{ env.FAILED_COUNT }}" -gt 0 ]; then
            echo "### Failed Services" >> $GITHUB_STEP_SUMMARY
            for SERVICE in ${{ env.FAILED_SERVICES }}; do
              echo "- ‚ùå $SERVICE" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ env.PASSED_COUNT }}" -gt 0 ]; then
            echo "### Healthy Services" >> $GITHUB_STEP_SUMMARY
            for SERVICE in ${{ env.PASSED_SERVICES }}; do
              echo "- ‚úÖ $SERVICE" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Create issue for failures
        if: env.FAILED_COUNT > 0
        uses: actions/github-script@v7
        with:
          script: |
            const failedServices = process.env.FAILED_SERVICES.split(' ');
            const date = new Date().toISOString().split('T')[0];
            
            const issueBody = `
            ## üö® Service Health Check Failures
            
            **Date:** ${date}
            **Failed Services:** ${failedServices.length}
            
            ### Failed Services
            ${failedServices.map(s => `- ‚ùå ${s}`).join('\n')}
            
            ### Action Required
            1. Investigate each failed service
            2. Check service logs
            3. Verify connectivity
            4. Review recent deployments
            
            ### Resources
            - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Troubleshooting Guide](./docs/TROUBLESHOOTING.md)
            
            _This issue was automatically created by the health check workflow._
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Health Check Failed: ${failedServices.length} service(s) - ${date}`,
              body: issueBody,
              labels: ['health-check', 'automated']
            });

      - name: Fail workflow if any service failed
        if: env.FAILED_COUNT > 0
        run: |
          echo "‚ùå ${{ env.FAILED_COUNT }} service(s) failed health check"
          exit 1
