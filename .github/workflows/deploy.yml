name: Deploy Service

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      services: ${{ steps.changes.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          
          # Extract unique service names
          SERVICES=$(echo "$CHANGED_FILES" | grep '^services/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Changed services: $SERVICES"

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    runs-on: self-hosted
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
      max-parallel: 2
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate service directory
        run: |
          SERVICE_PATH="services/${{ matrix.service }}"
          
          if [ ! -d "$SERVICE_PATH" ]; then
            echo "‚ùå Service directory not found: $SERVICE_PATH"
            exit 1
          fi
          
          if [ ! -f "$SERVICE_PATH/deploy.sh" ]; then
            echo "‚ùå deploy.sh not found in $SERVICE_PATH"
            exit 1
          fi
          
          if [ ! -x "$SERVICE_PATH/deploy.sh" ]; then
            echo "‚ö†Ô∏è  Making deploy.sh executable"
            chmod +x "$SERVICE_PATH/deploy.sh"
          fi
          
          echo "‚úÖ Service validation passed"

      - name: Pre-deployment checks
        run: |
          echo "üîç Pre-deployment checks for ${{ matrix.service }}"
          echo "Runner: $(hostname)"
          echo "Runner IP: $(hostname -I | awk '{print $1}')"
          echo "Date: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"

      - name: Deploy ${{ matrix.service }}
        env:
          PROXMOX_API_URL: ${{ secrets.PROXMOX_API_URL }}
          PROXMOX_API_TOKEN: ${{ secrets.PROXMOX_API_TOKEN }}
          DOCKER_HOST_IP: ${{ secrets.DOCKER_HOST_IP }}
          SERVICE_NAME: ${{ matrix.service }}
        run: |
          echo "üöÄ Deploying ${{ matrix.service }}..."
          cd services/${{ matrix.service }}
          
          # Run deployment script with timeout
          timeout 600 ./deploy.sh 2>&1 | tee deploy.log
          
          DEPLOY_STATUS=${PIPESTATUS[0]}
          
          if [ $DEPLOY_STATUS -eq 0 ]; then
            echo "‚úÖ Deployment successful"
          else
            echo "‚ùå Deployment failed with status $DEPLOY_STATUS"
            exit $DEPLOY_STATUS
          fi

      - name: Health check
        if: success()
        run: |
          SERVICE_PATH="services/${{ matrix.service }}"
          
          if [ -f "$SERVICE_PATH/health-check.sh" ]; then
            echo "üè• Running health check for ${{ matrix.service }}"
            chmod +x "$SERVICE_PATH/health-check.sh"
            
            # Give service time to start
            sleep 10
            
            # Run health check with timeout
            timeout 60 "$SERVICE_PATH/health-check.sh"
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Health check passed"
            else
              echo "‚ùå Health check failed"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  No health check script found, skipping"
          fi

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs-${{ matrix.service }}-${{ github.run_number }}
          path: services/${{ matrix.service }}/deploy.log
          retention-days: 90

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          # Clean up temporary files if any
          rm -f services/${{ matrix.service }}/*.tmp

  notify:
    needs: deploy
    if: always()
    runs-on: self-hosted
    steps:
      - name: Deployment status notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ All deployments successful"
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "‚ùå One or more deployments failed"
            # TODO: Add Slack/Discord notification here
          else
            echo "‚ö†Ô∏è  Deployment status: ${{ needs.deploy.result }}"
          fi
